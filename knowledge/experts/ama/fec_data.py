impairments_data = {
    "03.01.00.00": (5, "Valvular Heart Disease"),
    "03.02.00.00": (5, "Coronary Heart Disease"),
    "03.03.00.00": (5, "Congenital Heart Disease"),
    "03.04.00.00": (5, "Cardiomyopathies"),
    "03.05.00.00": (5, "Pericardial Heart Disease"),
    "03.06.00.00": (5, "Arrhythmia"),
    "04.01.00.00": (5, "Hypertensive Cardiovascular Disease"),
    "04.02.00.00": (5, "Aortic Disease"),
    "04.03.01.00": (5, "Peripheral Vascular Disease, Upper Extremities"),
    "04.03.02.00": (5, "Peripheral Vascular Disease, Lower Extremities"),
    "04.04.00.00": (7, "Pulmonary Circulation Disease"),
    "05.01.00.00": (7, "Asthma"),
    "05.02.00.00": (7, "Respiratory Disorders"),
    "05.03.00.00": (7, "Cancer"),
    "06.01.00.00": (6, "Upper Digestive Tract"),
    "06.02.00.00": (6, "Colon, Rectum, Anus"),
    "06.03.00.00": (6, "Enterocutaneous Fistulas"),
    "06.04.00.00": (6, "Liver/Biliary Tract"),
    "06.05.00.00": (6, "Hernias"),
    "07.01.00.00": (2, "Upper Urinary Tract"),
    "07.02.00.00": (2, "Urinary Diversion"),
    "07.03.00.00": (2, "Bladder"),
    "07.04.00.00": (2, "Urethra"),
    "07.05.00.00": (2, "Reproductive System"),
    "08.01.00.00": (2, "Disfigurement"),
    "08.02.00.00": (2, "Scars & Skin Grafts"),
    "08.03.00.00": (2, "Contact Dermatitis"),
    "08.04.00.00": (2, "Latex Allergy"),
    "08.05.00.00": (2, "Skin Cancer"),
    "09.01.00.00": (2, "Hematopoietic Impairment"),
    "10.01.00.00": (2, "Diabetes Mellitus"),
    "11.01.01.00": (8, "Ear Hearing Impairment"),
    "11.01.02.00": (8, "Ear Vestibular Disorder"),
    "11.02.01.00": (2, "Face/cosmetic"),
    "11.02.02.00": (2, "Face/eye/cosmetic"),
    "11.03.01.00": (2, "Nose/Throat/Related Structures Respiration"),
    "11.03.02.00": (2, "Nose/Throat/Related Structures Mastication & Deglutition"),
    "11.03.03.00": (2, "Nose/Throat/Related Structures Olfaction & Taste"),
    "11.03.04.00": (2, "Nose/Throat/Related Structures Voice & Speech"),
    "12.01.00.00": (1, "Visual Acuity"),
    "12.02.00.00": (1, "Visual Field"),
    "12.03.00.00": (1, "Visual System"),
    "13.01.00.00": (6, "Consciousness Disorder"),
    "13.02.00.00": (2, "Episodic Neurologic Disorder"),
    "13.03.00.00": (6, "Arousal Disorder"),
    "13.04.00.00": (2, "Cognitive Impairment"),
    "13.05.00.00": (2, "Language Disorder"),
    "13.06.00.00": (8, "Behavioral/Emotional Disorder"),
    "13.07.01.00": (2, "Cranial Nerve Olfactory"),
    "13.07.02.00": (1, "Cranial Nerve Optic"),
    "13.07.03.00": (2, "Cranial Nerve Oculomotor, Trochlear & Abducens"),
    "13.07.04.00": (2, "Cranial Nerve Trigeminal"),
    "13.07.05.00": (2, "Cranial Nerve Facial"),
    "13.07.06.01": (8, "Cranial Nerve Vestibulocochlear Vertigo"),
    "13.07.06.02": (8, "Cranial Nerve Vestibulocochlear Tinnitus"),
    "13.07.07.00": (2, "Cranial Nerve Glossopharyngeal & Valgus"),
    "13.07.08.00": (2, "Cranial Nerve Spinal Accessory"),
    "13.07.09.00": (2, "Cranial Nerve Hypoglossal"),
    "13.08.00.00": (5, "Station, Gait, Movement"),
    "13.09.00.00": (5, "Upper Extremities"),
    "13.10.01.00": (7, "Spinal Cord Disorder Respiratory"),
    "13.10.02.00": (2, "Spinal Cord Disorder Urinary"),
    "13.10.03.00": (2, "Spinal Cord Disorder Anorectal"),
    "13.10.04.00": (2, "Spinal Cord Disorder Sexual"),
    "13.11.01.01": (5, "Chronic Pain Upper Extremities Causalgia"),
    "13.11.01.02": (5, "Chronic Pain Upper Extremities Post-traumatic Neuralgia"),
    "13.11.01.03": (5, "Chronic Pain Upper Extremities Reflex Sympathetic Dystrophy"),
    "13.11.02.01": (5, "Chronic Pain Lower Extremities Causalgia"),
    "13.11.02.02": (5, "Chronic Pain Lower Extremities Post-traumatic Neuralgia"),
    "13.11.02.03": (5, "Chronic Pain Lower Extremities Reflex Sympathetic Dystrophy"),
    "13.12.01.01": (5, "Peripheral Nerve System Spine Sensory"),
    "13.12.01.02": (5, "Peripheral Nerve System Spine Motor"),
    "13.12.02.01": (5, "Peripheral Nerve System Upper Extremity Sensory"),
    "13.12.02.02": (5, "Peripheral Nerve System Upper Extremity Motor"),
    "13.12.03.01": (5, "Peripheral Nerve System Lower Extremity Sensory"),
    "13.12.03.02": (5, "Peripheral Nerve System Lower Extremity Motor"),
    "14.01.00.00": (8, "Psychiatric Mental and Behavioral"),
    "15.01.01.00": (5, "Cervical Diagnosis-related Estimate (DRE)"),
    "15.01.02.01": (5, "Cervical Range of Motion (ROM) Fracture"),
    "15.01.02.02": (5, "Cervical Range of Motion Soft Tissue Lesion"),
    "15.01.02.03": (5, "Cervical Range of Motion Spondylolysis, no operation"),
    "15.01.02.04": (5, "Cervical Range of Motion Stenosis, with operation"),
    "15.01.02.05": (5, "Cervical Range of Motion Nerve Root/Spinal Cord-Sensory"),
    "15.01.02.06": (5, "Cervical Range of Motion Nerve Root/Spinal Cord Motor"),
    "15.02.01.00": (5, "Thoracic Diagnosis-related Estimate"),
    "15.02.02.01": (5, "Thoracic Range of Motion Fracture"),
    "15.02.02.02": (5, "Thoracic Range of Motion Soft Tissue Lesion"),
    "15.02.02.03": (5, "Thoracic Range of Motion Spondylolysis, no operation"),
    "15.02.02.04": (5, "Thoracic Range of Motion Stenosis, with operation"),
    "15.02.02.05": (5, "Thoracic Range of Motion Nerve Root/Spinal Cord Sensory"),
    "15.02.02.06": (5, "Thoracic Range of Motion Nerve Root/Spinal Cord Motor"),
    "15.03.01.00": (5, "Lumbar Diagnosis-related Estimate"),
    "15.03.02.01": (5, "Lumbar Range of Motion Fracture"),
    "15.03.02.02": (5, "Lumbar Range of Motion Soft Tissue Lesion"),
    "15.03.02.03": (5, "Lumbar Range of Motion Spondylolysis, no operation"),
    "15.03.02.04": (5, "Lumbar Range of Motion Stenosis, with operation"),
    "15.03.02.05": (5, "Lumbar Range of Motion Nerve Root/Spinal Cord Sensory"),
    "15.03.02.06": (5, "Lumbar Range of Motion Nerve Root/Spinal Cord Motor"),
    "15.04.01.00": (5, "Corticospinal Tract One Upper Extremity"),
    "15.04.02.00": (5, "Corticospinal Tract Two Upper Extremities"),
    "15.04.03.00": (5, "Corticospinal Tract Station/Gait Disorder"),
    "15.04.04.00": (2, "Corticospinal Tract Bladder Impairment"),
    "15.04.05.00": (2, "Corticospinal Tract Anorectal Impairment"),
    "15.04.06.00": (2, "Corticospinal Tract Sexual Impairment"),
    "15.04.07.00": (7, "Corticospinal Tract Respiratory Impairment"),
    "15.05.01.00": (5, "Pelvic Healed Fracture"),
    "15.05.02.00": (5, "Pelvic Healed Fracture with Displacement"),
    "15.05.03.00": (5, "Pelvic Healed Fracture with Deformity"),
    "16.01.01.01": (5, "Arm Amputation/Deltoid insertion proximally"),
    "16.01.01.02": (5, "Arm Amputation/Bicipital insertion proximally"),
    "16.01.01.03": (5, "Arm Amputation/Wrist proximally"),
    "16.01.01.04": (5, "Arm Amputation/All fingers at MP joint proximally"),
    "16.01.02.01": (5, "Arm Peripheral neuropathy Brachial plexus"),
    "16.01.02.02": (4, "Arm Peripheral neuropathy Entrapment/compression Carpal tunnel"),
    "16.01.02.03": (5, "Arm Peripheral neuropathy Entrapment/compression Other"),
    "16.01.02.04": (5, "Arm Peripheral neuropathy CRPS I"),
    "16.01.02.05": (5, "Arm Peripheral neuropathy CRPS II"),
    "16.01.03.00": (5, "Arm Peripheral vascular"),
    "16.01.04.00": (4, "Arm Grip/pinch strength"),
    "16.01.05.00": (5, "Arm Other"),
    "16.02.01.00": (7, "Shoulder Range of motion"),
    "16.02.02.00": (7, "Shoulder Other"),
    "16.03.01.00": (2, "Elbow/forearm Range of motion"),
    "16.03.02.00": (2, "Elbow/forearm Other"),
    "16.04.01.00": (4, "Wrist Range of motion"),
    "16.04.02.00": (4, "Wrist Other"),
    "16.05.01.00": (1, "Hand/multiple fingers Range of motion"),
    "16.05.02.00": (1, "Hand/multiple fingers Amputation"),
    "16.05.03.00": (1, "Hand/multiple fingers Sensory"),
    "16.05.04.00": (1, "Hand/multiple fingers Other"),
    "16.06.01.01": (1, "Thumb Range of motion"),
    "16.06.01.02": (1, "Thumb Amputation"),
    "16.06.01.03": (1, "Thumb Sensory"),
    "16.06.01.04": (1, "Thumb Other"),
    "16.06.02.01": (1, "Index Range of motion"),
    "16.06.02.02": (1, "Index Amputation"),
    "16.06.02.03": (1, "Index Sensory"),
    "16.06.02.04": (1, "Index Other"),
    "16.06.03.01": (1, "Middle Range of motion"),
    "16.06.03.02": (1, "Middle Amputation"),
    "16.06.03.03": (1, "Middle Sensory"),
    "16.06.03.04": (1, "Middle Other"),
    "16.06.04.01": (1, "Ring Range of motion"),
    "16.06.04.02": (1, "Ring Amputation"),
    "16.06.04.03": (1, "Ring Sensory"),
    "16.06.04.04": (1, "Ring Other"),
    "16.06.05.01": (1, "Little Range of motion"),
    "16.06.05.02": (1, "Little Amputation"),
    "16.06.05.03": (1, "Little Sensory"),
    "16.06.05.04": (1, "Little Other"),
    "17.01.01.00": (5, "Leg Limb Length"),
    "17.01.02.01": (5, "Leg Amputation/Knee proximally"),
    "17.01.02.02": (5, "Leg Amputation/MTP joint proximally"),
    "17.01.03.00": (5, "Leg Skin Loss"),
    "17.01.04.00": (5, "Leg Peripheral Nerve"),
    "17.01.05.00": (5, "Leg Vascular"),
    "17.01.06.00": (5, "Leg Causalgia/RSD"),
    "17.01.07.00": (5, "Leg Gait Derangement"),
    "17.01.08.00": (5, "Leg Other"),
    "17.02.10.00": (5, "Pelvis Diagnosis-based estimate (DBE) Fracture"),
    "17.03.01.00": (5, "Hip Muscle Atrophy"),
    "17.03.02.00": (5, "Hip Ankylosis"),
    "17.03.03.00": (5, "Hip Arthritis"),
    "17.03.04.00": (5, "Hip Range of Motion"),
    "17.03.05.00": (5, "Hip Muscle Strength"),
    "17.03.06.00": (5, "Hip Other"),
    "17.03.10.01": (5, "Hip Diagnosis-based Estimate Hip/Replacement"),
    "17.03.10.02": (5, "Hip Diagnosis-based Estimate Hip/Femoral Neck Fracture"),
    "17.03.10.03": (5, "Hip Diagnosis-based Estimate Hip/Arthroplasty"),
    "17.03.10.04": (5, "Hip Diagnosis-based Estimate Trochanteric bursitis"),
    "17.04.10.00": (5, "Femur Diagnosis-based Estimate Fracture"),
    "17.05.01.00": (2, "Knee Muscle Atrophy"),
    "17.05.02.00": (2, "Knee Ankylosis"),
    "17.05.03.00": (2, "Knee Arthritis"),
    "17.05.04.00": (2, "Knee Range of Motion"),
    "17.05.05.00": (2, "Knee Muscle Strength"),
    "17.05.06.00": (2, "Knee Other"),
    "17.05.10.01": (2, "Knee Diagnosis-based Estimate Subluxation/dislocation"),
    "17.05.10.02": (2, "Knee Diagnosis-based Estimate Fracture"),
    "17.05.10.03": (2, "Knee Diagnosis-based Estimate Patellectomy"),
    "17.05.10.04": (2, "Knee Diagnosis-based Estimate Menisectomy"),
    "17.05.10.05": (2, "Knee Diagnosis-based Estimate Cruciate/collateral Ligament"),
    "17.05.10.06": (2, "Knee Diagnosis-based Estimate Plateau Fracture"),
    "17.05.10.07": (2, "Knee Diagnosis-based Estimate Supra/Intercondylar Fracture"),
    "17.05.10.08": (2, "Knee Diagnosis-based Estimate Total Replacement"),
    "17.05.10.09": (2, "Knee Diagnosis-based Estimate Proximal Tibial osteotomy"),
    "17.06.10.00": (5, "Tibia/fibula Diagnosis-based Estimate fracture"),
    "17.07.01.00": (2, "Ankle Muscle Atrophy"),
    "17.07.02.00": (2, "Ankle Ankylosis"),
    "17.07.03.00": (2, "Ankle Arthritis"),
    "17.07.04.00": (2, "Ankle Range of Motion"),
    "17.07.05.00": (2, "Ankle Muscle Strength"),
    "17.07.06.00": (2, "Ankle Other"),
    "17.07.10.01": (2, "Ankle Diagnosis-based Estimate Ligament Instability"),
    "17.07.10.02": (2, "Ankle Diagnosis-based Estimate Fracture"),
    "17.08.01.00": (2, "Foot Muscle Atrophy"),
    "17.08.02.00": (2, "Foot Ankylosis"),
    "17.08.03.00": (2, "Foot Arthritis"),
    "17.08.04.00": (2, "Foot Range of Motion"),
    "17.08.05.00": (2, "Foot Muscle Strength"),
    "17.08.06.00": (2, "Foot Other"),
    "17.08.10.01": (2, "Foot Diagnosis-based Estimate Hind Foot Fracture"),
    "17.08.10.02": (2, "Foot Diagnosis-based Estimate Loss of Tibia"),
    "17.08.10.03": (2, "Foot Diagnosis-based Estimate Intra-articular Fracture"),
    "17.08.10.04": (2, "Foot Diagnosis-based Estimate Calvus"),
    "17.08.10.05": (2, "Foot Diagnosis-based Estimate Rocker Bottom"),
    "17.08.10.06": (2, "Foot Diagnosis-based Estimate Avascular Necrosis"),
    "17.08.10.07": (2, "Foot Diagnosis-based Estimate Metatarsal fracture"),
    "17.09.01.00": (5, "Toes Muscle Atrophy"),
    "17.09.02.00": (5, "Toes Ankylosis"),
    "17.09.03.00": (5, "Toes Arthritis"),
    "17.09.04.00": (5, "Toes Range of Motion"),
    "17.09.05.00": (5, "Toes Muscle Strength"),
    "17.09.06.00": (5, "Toes Amputation"),
    "17.09.07.00": (5, "Toes Other"),
}

def get_impairment_data(impairment_number):
    fec_rank, impairment_name = impairments_data[impairment_number]
    print(f"\n[Impairment Analysis] Impairment Number: {impairment_number}")
    print(f"[Impairment Analysis] FEC Rank: {fec_rank}")
    print(f"[Impairment Analysis] Impairment Name: {impairment_name}\n")
    return fec_rank, impairment_name


def get_impairments_phrase_match(phrase, required_match=None):
    if required_match:
        possible_impairments = {code: details for code, details in impairments_data.items() if phrase.lower() in details[1].lower() and required_match.lower() in details[1].lower()}
    else:
        possible_impairments = {code: details for code, details in impairments_data.items() if phrase.lower() in details[1].lower()}

    if len(possible_impairments) == 1:
        impairment_number = next(iter(possible_impairments))
        print(f"\n[IMPAIRMENT MATCH] Exact match found for {impairment_number.upper()}: {possible_impairments[impairment_number][1]}")
        return get_impairment_data(impairment_number)
    elif possible_impairments:
        return possible_impairments
    else:
        return get_impairments_word_match(phrase, required_match)

def get_impairments_word_match(phrase, required_match=None):
    words = phrase.lower().split()
    if required_match:
        possible_impairments = {code: details for code, details in impairments_data.items() if any(word in details[1].lower() for word in words) and required_match.lower() in details[1].lower()}
    else:
        possible_impairments = {code: details for code, details in impairments_data.items() if any(word in details[1].lower() for word in words)}

    if len(possible_impairments) == 1:
        impairment_number = next(iter(possible_impairments))
        print(f"\n[IMPAIRMENT MATCH] Match found for individual word(s) in {impairment_number.upper()}: {possible_impairments[impairment_number][1]}")
        return get_impairment_data(impairment_number)
    else:
        return possible_impairments


def get_unique_impairments_for_phrases(phrases):
    unique_matches = {}
    for phrase in phrases:
        matches = get_impairments_phrase_match(phrase)
        if isinstance(matches, dict):
            unique_matches.update(matches)
        else:
            if isinstance(matches, tuple) and len(matches) == 2:
                unique_matches[matches[0]] = matches[1]
            else:
                raise ValueError("Unexpected format of matches: {}".format(matches))
    return unique_matches



# This is a great function that converts totally messed up lists into lists.
def process_ai_input_for_phrases(input_string):
    import ast
    import re

    try:
        phrases = ast.literal_eval(input_string)
        if not isinstance(phrases, list):
            raise ValueError("The evaluated expression is not a list")
    except (ValueError, SyntaxError):
        cleaned_string = re.sub(r'[^a-zA-Z\s]+', '|', input_string)
        phrases = [phrase.strip() for phrase in cleaned_string.split('|') if len(phrase.strip()) >= 3]
        print(f"\n[INPUT PROCESSING] Input string processed as phrases: {phrases}\n")
    unique_matches = get_unique_impairments_for_phrases(phrases)

    return unique_matches


if __name__ == "__main__":
    from common import pretty_print
    #impairment_number = "15.01.02.02"
    #fec_rank, impairment_name = get_impairment_data(impairment_number)

    #possible_impairments = get_impairments_phrase_match("Cervical Spine")

    #possible_impairments = get_unique_impairments_for_phrases(["Cervical Spine", "Right Shoulder", "Left Shoulder", "Lumbar Spine"])
    possible_impairments = process_ai_input_for_phrases('["shoulder range of motion"]')  # , "Right Shoulder", "Left Shoulder", "Lumbar Spine"

    print(possible_impairments)
    pretty_print(possible_impairments)
